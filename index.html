<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Board (Online Shared)</title>

  <!-- Стили и иконки -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" type="image/png" />
  <meta name="theme-color" content="#131722" />
</head>

<body>
  <header>
    <h1>KPI Board</h1>
    <span class="tag">Firebase Shared</span>
  </header>

  <main>
    <aside class="side">
      <div class="group">
        <button id="addKpi">Добавить KPI</button>
        <button id="addWeek">Добавить неделю</button>
        <button id="delRow">Удалить строку</button>
      </div>
    </aside>

    <section class="grid-wrap">
      <table id="kpiTable">
        <thead>
          <tr id="theadRow">
            <th class="col-kpi">KPI name</th>
            <th class="col-target">Target</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <footer class="usersbar">
        <div id="users"></div>
        <div class="addUser">
          <input id="newUserName" placeholder="Добавить имя..." />
          <button id="addUser">+</button>
        </div>
      </footer>
    </section>
  </main>

  <!-- ==== Firebase + Auth + Firestore (единственный модульный скрипт) ==== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Конфигурация Firebase проекта
    const firebaseConfig = {
      apiKey: "AIzaSyCb92dCbGD4H_YHPGt9SSPukDc7zlk9CpU",
      authDomain: "kpi-board-139b1.firebaseapp.com",
      projectId: "kpi-board-139b1",
      storageBucket: "kpi-board-139b1.firebasestorage.app",
      messagingSenderId: "805537122913",
      appId: "1:805537122913:web:69457a3a36173f5720b820"
    };

    // Инициализация Firebase
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => {});

    // ===== Департаменты и должности =====
    const DEPARTMENTS = ["Administration", "Accounting", "Dispatching"];
    const POSITIONS_BY_DEPT = {
      "Administration": ["Director", "Team Leader", "Driver Evaluator", "Capacity Planner", "Driver Manager", "Driver Administrator"],
      "Accounting": ["Team Leader", "Manager", "Payroll"],
      "Dispatching": ["Team Leader", "Dispo FTL", "Dispo XTL/ODC"]
    };
    const DIRECTOR_POSITIONS = ["Director"];
    const LEADER_POSITIONS   = ["Team Leader"];

    function buildOptions(list, placeholder) {
      return `<option value="" disabled selected>${placeholder}</option>` +
        list.map(v => `<option value="${v}">${v}</option>`).join("");
    }
    function roleFromPosition(position){
      if (DIRECTOR_POSITIONS.includes(position)) return "director";
      if (LEADER_POSITIONS.includes(position))   return "leader";
      return "member";
    }

    // ----- Пробрасываем в глобал для app.js -----
    window.__FB_AUTH = auth;
    window.__FB_DB   = db;
    window.__fbDoc    = doc;
    window.__fbGetDoc = getDoc;
    window.__fbSetDoc = setDoc;
    window.__fbSnap   = onSnapshot;
    window.__fbLogout = async () => { try { await signOut(auth); } catch(e){ alert("Logout error: " + e.message); } };

    // ===== Экран логина / регистрации =====
    window.showLoginScreen = function(){
      if (document.querySelector('#authBox')) return;

      const box = document.createElement('div');
      box.id = 'authBox';
      box.style = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100000;background:rgba(2,6,10,0.7)";
      box.innerHTML = `
        <div style="width:460px;background:#0f1620;border:1px solid #223;padding:20px;border-radius:12px;color:#e8eef5;box-shadow:0 10px 40px rgba(0,0,0,.5)">
          <h3 style="margin-top:0">KPI Board — Вход / Регистрация</h3>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="authFirst"  type="text" placeholder="First name"  style="grid-column:1/2;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>
            <input id="authLast"   type="text" placeholder="Last name"   style="grid-column:2/3;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>

            <select id="authDept"  style="grid-column:1/3;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"></select>
            <select id="authPos"   style="grid-column:1/3;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"></select>

            <input id="authEmail"  type="email" placeholder="Email" style="grid-column:1/3;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>
            <input id="authPass"   type="password" placeholder="Password" style="grid-column:1/3;padding:10px;border-radius:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="btnLogin"     style="padding:8px 12px;border-radius:8px">Войти</button>
            <button id="btnRegister"  style="padding:8px 12px;border-radius:8px">Регистрация</button>
          </div>
          <div style="margin-top:8px;font-size:12px;color:#a8b6c9">
            При регистрации вы будете добавлены в выбранный департамент.
          </div>
        </div>
      `;
      document.body.appendChild(box);

      const selDept = box.querySelector('#authDept');
      const selPos  = box.querySelector('#authPos');
      selDept.innerHTML = buildOptions(DEPARTMENTS, "Select department");
      selPos.innerHTML  = buildOptions([], "Select position");
      selDept.onchange = () => {
        const list = POSITIONS_BY_DEPT[selDept.value] || [];
        selPos.innerHTML = buildOptions(list, "Select position");
      };

      // ===== Регистрация =====
      box.querySelector('#btnRegister').onclick = async () => {
        const first = box.querySelector('#authFirst').value.trim();
        const last  = box.querySelector('#authLast').value.trim();
        const dept  = selDept.value;
        const pos   = selPos.value;
        const email = box.querySelector('#authEmail').value.trim();
        const pass  = box.querySelector('#authPass').value;

        if (!first || !last || !dept || !pos || !email || !pass) {
          alert("Заполните все поля");
          return;
        }

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          const uid  = cred.user.uid;
          const displayName = `${first} ${last}`;
          const role = roleFromPosition(pos);

          await setDoc(doc(db, "users", uid), {
            displayName, email, department: dept, position: pos, role, createdAt: Date.now()
          });

          window.currentUserProfile = { displayName, email, department: dept, position: pos, role };

          window.hideLoginScreen && window.hideLoginScreen();
          window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: auth.currentUser }));
        } catch (err) {
          alert("Ошибка регистрации: " + err.message);
        }
      };

      // ===== Вход =====
      box.querySelector('#btnLogin').onclick = async () => {
        const email = box.querySelector('#authEmail').value.trim();
        const pass  = box.querySelector('#authPass').value;

        try {
          const cred = await signInWithEmailAndPassword(auth, email, pass);
          const snap = await getDoc(doc(db, "users", cred.user.uid));
          if (snap.exists()) window.currentUserProfile = snap.data();

          window.hideLoginScreen && window.hideLoginScreen();
          window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: auth.currentUser }));
        } catch (err) {
          alert("Ошибка входа: " + err.message);
        }
      };
    };

    window.hideLoginScreen = function() {
      document.querySelector('#authBox')?.remove();
    };

    // ===== Загрузка профиля =====
    async function loadUserProfile(uid){
      try {
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists()) {
          window.currentUserProfile = snap.data();
        } else {
          window.currentUserProfile = null;
          console.warn("Профиль не найден для uid:", uid);
        }
      } catch(e){
        console.error("Ошибка загрузки профиля:", e);
        window.currentUserProfile = null;
      }
    }

    // ===== Слушаем авторизацию =====
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await loadUserProfile(user.uid);
      } else {
        window.currentUserProfile = null;
      }
      window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: user || null }));
    });
  </script>

  <!-- ==== Основное приложение ==== -->
  <script src="app.js"></script>

  <!-- ==== Service Worker для PWA ==== -->
  <script>
    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    }
  </script>
</body>
</html>
