<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Board (Online Shared)</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.webmanifest">
</head>
<body>
<header>
  <h1>KPI Board</h1>
  <span class="tag">Firebase Shared</span>
</header>

<main>
  <aside class="side">
    <div class="group">
      <button id="addKpi">Добавить KPI</button>
      <button id="addWeek">Добавить неделю</button>
      <button id="delRow">Удалить строку</button>
    </div>
  </aside>

  <section class="grid-wrap">
    <table id="kpiTable">
      <thead>
        <tr id="theadRow">
          <th class="col-kpi">KPI name</th>
          <th class="col-target">Target</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <footer class="usersbar">
      <div id="users"></div>
      <div class="addUser">
        <input id="newUserName" placeholder="Добавить имя..." />
        <button id="addUser">+</button>
      </div>
    </footer>
  </section>
</main>

<!-- ==== Firebase + Auth + Firestore (единственный модульный скрипт) ==== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence 
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Конфиг твоего проекта
  const firebaseConfig = {
    apiKey: "AIzaSyCb92dCbGD4H_YHPGt9SSPukDc7zlk9CpU",
    authDomain: "kpi-board-139b1.firebaseapp.com",
    projectId: "kpi-board-139b1",
    storageBucket: "kpi-board-139b1.firebasestorage.app",
    messagingSenderId: "805537122913",
    appId: "1:805537122913:web:69457a3a36173f5720b820"
  };

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Офлайн-кэш Firestore (не страшно, если уже включён)
  enableIndexedDbPersistence(db).catch(() => {});

  // Пробрасываем в глобал для app.js
  window.__FB_AUTH = auth;
  window.__FB_DB   = db;
  window.__fbDoc    = doc;
  window.__fbGetDoc = getDoc;
  window.__fbSetDoc = setDoc;
  window.__fbSnap   = onSnapshot;
  window.__fbLogout = async () => { try { await signOut(auth); } catch(e){ alert("Logout error: "+e.message); } };

  // ==== Мини-окно Вход / Регистрация ====
  window.showLoginScreen = function() {
    if (document.querySelector('#authBox')) return;
    const box = document.createElement('div');
    box.id = 'authBox';
    box.style = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100000;background:rgba(2,6,10,0.7)";
    box.innerHTML = `
      <div style="width:360px;background:#0f1620;border:1px solid #223;padding:20px;border-radius:12px;color:#e8eef5;box-shadow:0 10px 40px rgba(0,0,0,.5)">
        <h3 style="margin-top:0">KPI Board — Вход / Регистрация</h3>
        <input id="authEmail" type="email" placeholder="Email" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>
        <input id="authPass"  type="password" placeholder="Пароль" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;background:#0f1824;border:1px solid #2b3648;color:#e8eef5"/>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnLogin" style="padding:8px 12px;border-radius:8px">Войти</button>
          <button id="btnRegister" style="padding:8px 12px;border-radius:8px">Регистрация</button>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#a8b6c9">После входа окно закроется и загрузится общая база KPI.</div>
      </div>
    `;
    document.body.appendChild(box);

    box.querySelector('#btnRegister').onclick = async () => {
      const email = box.querySelector('#authEmail').value.trim();
      const pass  = box.querySelector('#authPass').value;
      try { await createUserWithEmailAndPassword(auth, email, pass); }
      catch(err){ alert('Ошибка регистрации: ' + err.message); }
    };
    box.querySelector('#btnLogin').onclick = async () => {
      const email = box.querySelector('#authEmail').value.trim();
      const pass  = box.querySelector('#authPass').value;
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch(err){ alert('Ошибка входа: ' + err.message); }
    };
  };

  window.hideLoginScreen = function(){
    const el = document.querySelector('#authBox');
    if (el) el.remove();
  };

  // Транслируем изменение авторизации в приложение
  onAuthStateChanged(auth, (user) => {
    window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: user || null }));
  });
</script>

<!-- ==== Основное приложение ==== -->
<script src="app.js"></script>

<!-- ==== Регистрация SW только на https/localhost (чтобы не ругался на file://) ==== -->
<script>
  if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
</script>

</body>
</html>
