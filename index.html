<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Board</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#f6f7fb" />

  <!-- –°—Ç–∏–ª–∏ (–Ω–æ–≤—ã–µ —Å–æ —Å–≤–µ—Ç–ª–æ–π/—Ç—ë–º–Ω–æ–π —Ç–µ–º–∞–º–∏) -->
  <link rel="stylesheet" href="styles.css" />

  <!-- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã –±–µ–∑ –º–∏–≥–∞–Ω–∏—è -->
  <script>
    (function(){
      const KEY = 'kpi-theme';
      const saved = localStorage.getItem(KEY);
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode = saved || (prefersDark ? 'dark' : 'light');
      if (mode === 'dark') document.documentElement.classList.add('theme-dark');
    })();
  </script>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header>
    <h1>KPI Board</h1>
    <div class="header-actions">
      <button id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåó Theme</button>
      <!-- —Å–ø—Ä–∞–≤–∞ –º–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å —Ç–≤–æ—ë –º–µ–Ω—é ‚â°, –µ—Å–ª–∏ –æ–Ω–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ JS -->
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –ª–µ–π–∞—É—Ç: –ª–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä + –∫–æ–Ω—Ç–µ–Ω—Ç (—Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∏–∑ app.js) -->
  <main>
    <aside id="sidebar"></aside>
    <section id="content" class="section">
      <!-- –¢–∞–±–ª–∏—Ü–∞/–Ω–∞–≤–∏–≥–∞—Ü–∏—è/—á–∏–ø—ã –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∏—Ç app.js -->
    </section>
  </main>

  <!-- –¢–æ–≥–≥–ª–µ—Ä —Ç–µ–º—ã (–ø—Ä–æ—Å—Ç–æ–π, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π) -->
  <script>
    (function(){
      const KEY = 'kpi-theme';
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      btn.addEventListener('click', ()=>{
        const root = document.documentElement;
        const isDark = root.classList.toggle('theme-dark');
        localStorage.setItem(KEY, isDark ? 'dark' : 'light');
      });
    })();
  </script>

  <!-- ==== Firebase + Auth + Firestore (–æ–±—ë—Ä—Ç–∫–∏ –¥–ª—è app.js) ==== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot,
      enableIndexedDbPersistence, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- —Ç–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
    const firebaseConfig = {
      apiKey: "AIzaSyCb92dCbGD4H_YHPGt9SSPukDc7zlk9CpU",
      authDomain: "kpi-board-139b1.firebaseapp.com",
      projectId: "kpi-board-139b1",
      storageBucket: "kpi-board-139b1.firebasestorage.app",
      messagingSenderId: "936203643572",
      appId: "1:936203643572:web:0e2f1b1e1df8b8d3e5b6a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // –æ—Ñ–ª–∞–π–Ω-–∫—ç—à Firestore (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
    try { await enableIndexedDbPersistence(db); } catch(_) {}

    // –†–æ–ª–∏/–ø–æ–∑–∏—Ü–∏–∏ (–∫–∞–∫ —É —Ç–µ–±—è)
    const POSITIONS = {
      "Administration": [
        "Director","Team Leader","Driver Evaluator","Capacity Planner","Driver Manager","Driver Administrator"
      ],
      "Accounting": ["Team Leader","Manager","Payroll"],
      "Dispatching": ["Team Leader","Dispo FTL","Dispo XTL/ODC"]
    };
    const DIRECTOR_POSITIONS = ["Director"];
    const LEADER_POSITIONS   = ["Team Leader"];

    function roleFromPosition(position){
      if (DIRECTOR_POSITIONS.includes(position)) return "director";
      if (LEADER_POSITIONS.includes(position))   return "leader";
      return "member";
    }

    // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë, —á—Ç–æ –∂–¥—ë—Ç app.js
    window.__FB_AUTH = auth;
    window.__FB_DB   = db;
    window.__fbDoc    = doc;
    window.__fbGetDoc = getDoc;
    window.__fbSetDoc = setDoc;
    window.__fbSnap   = onSnapshot;
    window.__fbServerTimestamp = serverTimestamp;
    window.__fbLogout = async () => { try { await signOut(auth); } catch(e){ alert("Logout error: "+e.message); } };

    // ==== –ü—Ä–æ—Å—Ç–µ–π—à–∞—è Login/Register —Ñ–æ—Ä–º–∞ (–∫–∞–∫ —É —Ç–µ–±—è) ====
    window.showLoginScreen = function(){
      if (document.querySelector('#authBox')) return;
      const box = document.createElement('div');
      box.id = 'authBox';
      box.style = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10000;background:rgba(0,0,0,0.5)";
      box.innerHTML = `
        <div style="width:440px;background:var(--surface);border-radius:14px;padding:20px;border:1px solid var(--border);color:var(--text);box-shadow:var(--shadow)">
          <h3 style="margin:0 0 10px 0">KPI Board ‚Äî Login / Register</h3>
          <div style="display:grid;gap:8px;margin:10px 0">
            <input id="authFirst"  type="text" placeholder="First name"  />
            <input id="authLast"   type="text" placeholder="Last name"   />
            <input id="authEmail"  type="email" placeholder="Email"      />
            <input id="authPass"   type="password" placeholder="Password" />
            <select id="authDept">
              ${Object.keys(POSITIONS).map(d=>`<option value="${d}">${d}</option>`).join("")}
            </select>
            <select id="authPos"></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="btnRegister" class="btn btn-primary">Register</button>
            <button id="btnLogin" class="btn">Login</button>
          </div>
        </div>
      `;
      document.body.appendChild(box);

      const deptSel = box.querySelector('#authDept');
      const posSel  = box.querySelector('#authPos');
      const fillPos = () => {
        const arr = POSITIONS[deptSel.value] || [];
        posSel.innerHTML = arr.map(p=>`<option value="${p}">${p}</option>`).join("");
      };
      deptSel.addEventListener('change', fillPos); fillPos();

      // Register
      box.querySelector("#btnRegister").onclick = async () => {
        const first = box.querySelector("#authFirst").value.trim();
        const last  = box.querySelector("#authLast").value.trim();
        const email = box.querySelector("#authEmail").value.trim();
        const pass  = box.querySelector("#authPass").value;
        const dept  = deptSel.value;
        const pos   = posSel.value;
        if (!email || !pass || !first || !last) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          const uid = cred.user.uid;
          const displayName = `${first} ${last}`;
          const role = roleFromPosition(pos);
          await setDoc(doc(db, "users", uid), { displayName, email, department: dept, position: pos, role });
          window.currentUserProfile = { displayName, email, department: dept, position: pos, role };
          window.hideLoginScreen && window.hideLoginScreen();
          window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: auth.currentUser }));
        } catch(err) {
          alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + err.message);
        }
      };

      // Login
      box.querySelector("#btnLogin").onclick = async () => {
        const email = box.querySelector("#authEmail").value.trim();
        const pass  = box.querySelector("#authPass").value;
        try {
          const cred = await signInWithEmailAndPassword(auth, email, pass);
          const snap = await getDoc(doc(db, "users", cred.user.uid));
          if (snap.exists()) window.currentUserProfile = snap.data();
          window.hideLoginScreen && window.hideLoginScreen();
          window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: auth.currentUser }));
        } catch(err) {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
        }
      };
    };

    window.hideLoginScreen = () => {
      const el = document.querySelector("#authBox");
      if (el) el.remove();
    };

    async function loadUserProfile(uid){
      try {
        const s = await getDoc(doc(db, "users", uid));
        window.currentUserProfile = s.exists() ? s.data() : null;
      } catch {
        window.currentUserProfile = null;
      }
    }

    onAuthStateChanged(auth, async (user)=>{
      if (user) await loadUserProfile(user.uid);
      else window.currentUserProfile = null;
      window.dispatchEvent(new CustomEvent('fbAuthChanged', { detail: user || null }));
    });
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
  <script src="app.js"></script>
</body>
</html>
